<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>Twitch Lurker Detector (TMI.js)</title>
    <script src="https://github.com/tmijs/tmi.js/releases/download/v1.8.5/tmi.min.js"></script>
    <style>
        body {
            background-color: #050505;
            color: #00ff41;
            font-family: 'Consolas', 'Courier New', monospace;
            padding: 20px;
        }

        h2 {
            border-bottom: 2px solid #00ff41;
            display: inline-block;
            padding-bottom: 5px;
        }

        #log {
            margin-top: 20px;
            border: 1px dashed #333;
            padding: 10px;
            height: 500px;
            overflow-y: scroll;
            background: #000;
            font-size: 14px;
        }

        .new-viewer {
            color: #ff0055;
            text-shadow: 0 0 5px #ff0055;
            font-weight: bold;
        }

        .old-viewer {
            color: #444;
        }

        .system {
            color: #00ffff;
        }
    </style>
</head>

<body>
    <h2>ü§ñ System: TMI.js Join Scanner</h2>
    <div>Status: <span id="status" style="color:orange">Connecting...</span></div>
    <button id="clearBtn"
        style="margin-top: 10px; background-color: #333; color: #00ff41; border: 1px solid #00ff41; padding: 5px 10px;">Clear
        Viewers DB</button>
    <div id="log"></div>
    <script>
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        const MY_CHANNEL = 'FRA3A'; // –í–ø–∏—à–∏ –Ω–∏–∫ —Å—Ç—Ä–æ—á–Ω—ã–º–∏ –±—É–∫–≤–∞–º–∏

        // --- –ë–ê–ó–ê –î–ê–ù–ù–´–• (INDEXED DB) ---
        // –õ–æ–≥–∏–∫–∞ –±–∞–∑—ã –æ—Å—Ç–∞–ª–∞—Å—å —Ç–∞–∫–æ–π –∂–µ, –æ–Ω–∞ –Ω–∞–¥–µ–∂–Ω–∞—è
        const dbName = "TwitchViewerDB";
        let db;
        const request = indexedDB.open(dbName, 1);

        request.onupgradeneeded = (e) => {
            db = e.target.result;
            if (!db.objectStoreNames.contains("viewers")) {
                db.createObjectStore("viewers", { keyPath: "username" });
            }
        };

        request.onsuccess = (e) => {
            db = e.target.result;
            logToScreen("DB", "IndexedDB connected.", "system");
            startTwitchListener(); // –ó–∞–ø—É—Å–∫–∞–µ–º TMI —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –±–∞–∑–∞ –≥–æ—Ç–æ–≤–∞
            document.getElementById('clearBtn').addEventListener('click', () => {
                const tx = db.transaction(["viewers"], "readwrite");
                const store = tx.objectStore("viewers");
                const clearReq = store.clear();
                clearReq.onsuccess = () => {
                    logToScreen("DB", "Viewers database cleared.", "system");
                };
            });
        };

        // --- –§–£–ù–ö–¶–ò–Ø –ü–†–û–í–ï–†–ö–ò ---
        const BOTS = ['streamelements', 'jeetbot', 'potatbotat', 'frostytoolsdotcom', 'moobot', 'nightbot'];

        function checkViewer(username, event = '') {
            if (BOTS.includes(username)) return;

            const tx = db.transaction(["viewers"], "readwrite");
            const store = tx.objectStore("viewers");
            const req = store.get(username);

            req.onsuccess = () => {
                if (req.result) {
                    // –°—Ç–∞—Ä–∏—á–æ–∫
                    if (event !== 'message') {
                        logToScreen("JOIN", `${username}`, "old-viewer");
                    }
                } else {
                    // –ù–æ–≤–µ–Ω—å–∫–∏–π
                    store.add({ username: username, firstSeen: Date.now() });
                    logToScreen("ALERT", `>>> NEW VIEWER: ${username} <<<`, "new-viewer");
                }
            };
        }

        // --- –õ–û–ì–ò–ö–ê TMI.JS ---
        function startTwitchListener() {
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–ª–∏–µ–Ω—Ç. identity –Ω–µ –Ω—É–∂–µ–Ω, –±—É–¥–µ–º –∞–Ω–æ–Ω–∏–º–∞–º–∏ (justinfan)
            const client = new tmi.Client({
                connection: {
                    secure: true,
                    reconnect: true
                },
                channels: [MY_CHANNEL]
            });

            client.connect().catch(console.error);

            // –°–æ–±—ã—Ç–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            client.on('connected', (address, port) => {
                document.getElementById('status').innerText = 'Online & Scanning';
                document.getElementById('status').style.color = '#00ff41';
                logToScreen("SYS", `Connected to ${address}:${port}`, "system");
            });

            // –°–æ–±—ã—Ç–∏–µ JOIN (–ö—Ç–æ-—Ç–æ –∑–∞—à–µ–ª)
            client.on('join', (channel, username, self) => {
                if (self) return; // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–µ–±—è (—Ö–æ—Ç—è –¥–ª—è –∞–Ω–æ–Ω–∏–º–∞ —ç—Ç–æ —Ä–µ–¥–∫–æ—Å—Ç—å)
                checkViewer(username);
            });

            // (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –°–æ–±—ã—Ç–∏–µ MESSAGE - –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –ª–æ–≤–∏—Ç—å —Ç–µ—Ö, –∫—Ç–æ –Ω–∞–ø–∏—Å–∞–ª, –Ω–æ join –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª
            client.on('message', (channel, tags, message, self) => {
                // tags['username'] - —ç—Ç–æ –Ω–∏–∫ –ø–∏—à—É—â–µ–≥–æ
                checkViewer(tags['username'], 'message');
            });
        }

        // --- –í–´–í–û–î –ù–ê –≠–ö–†–ê–ù ---
        function logToScreen(type, text, cssClass) {
            const logDiv = document.getElementById('log');
            const line = document.createElement('div');
            const time = new Date().toLocaleTimeString('ru-RU');
            line.innerHTML = `<span style="opacity:0.5">[${time}]</span> [${type}] <span class="${cssClass}">${text}</span>`;
            logDiv.appendChild(line);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
    </script>
</body>

</html>